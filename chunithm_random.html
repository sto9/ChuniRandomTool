<!DOCTYPE html>
<html lang="ja">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta charset="utf-8">
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <title>CHUNITHM 課題曲ツール（上級者向け）</title>

    <script language="javascript" type="text/javascript">
        let user_id = "";
        let records_origin;

        // 前と同じ ID なら呼ばない
        async function callApi() {
            if (user_id !== "" && user_id === document.getElementById('user_id').value) return false;
            if (document.getElementById('user_id').value === "") {
                document.getElementById('user_id_error').innerHTML = "<b>ユーザー ID を入力してください。</b>";
                return false;
            }
            const BASE_URL = "https://api.chunirec.net/2.0/records/showall.json?region=jp2&token=0cc61074c6f6ccf038b3c62be917be3ef317458be49bd3cd68c78a80b4d024b144db12e7f941a8c043f3ac8b4b0c610740e8960baf53f5469de414d6588fa6b5&user_name=";
            const URL = BASE_URL + document.getElementById('user_id').value;
            const res = await fetch(URL);
            if (!res.ok) {
                document.getElementById('user_id_error').innerHTML = "<b>不正なユーザー ID です。</b>";
                user_id = "";
                return false;
            }
            const json = await res.json();
            records_origin = await json["records"];
            user_id = document.getElementById('user_id').value;
            return true;
        }

        function pickUpRecords() {
            let records = [];
            let ultima = document.getElementById('ultima').checked;
            let lower = document.getElementById('level_lower').value;
            let upper = document.getElementById('level_upper').value;
            let AJC = document.getElementById('radio_AJC').checked;
            for (const record of records_origin) {
                if (!(record["diff"] === "MAS" || (record["diff"] === "ULT" && ultima))) continue;
                if (record["level"] < lower || record["level"] > upper) continue;
                if (document.getElementById('radio_AJC').checked) {
                    if (record["score"] == "1010000") continue;
                } else if (document.getElementById('radio_99AJ').checked) {
                    if (record["is_alljustice"] && record["score"] >= 1009900) continue;
                } else if (document.getElementById('radio_AJ').checked) {
                    if (record["is_alljustice"]) continue;
                }
                records.push(record);
            }
            return records;
        }

        function setTable(records) {
            let table = document.getElementById("table");
            while (table.firstChild) table.removeChild(table.firstChild);
            let display_number = document.getElementById('display_number').value;
            let idx = [...Array(records.length).keys()];

            let music_count = document.getElementById("music_count");
            music_count.innerHTML = "<b>" + records.length + "</b> 曲中 ";
            music_count.innerHTML += Math.min(records.length, display_number) + " 曲を表示"

            // shuffle
            for (let i = records.length - 1; i > 0; i--) {
                let k = Math.floor(Math.random() * i);
                [idx[i], idx[k]] = [idx[k], idx[i]];
            }
            let th = '<th scope="col" style="width: 55%">曲名</th>';
            th += '<th scope="col" style="width: 25%">スコア</th>';
            th += '<th scope="col" style="width: 10%">難易度</th>';
            th += '<th scope="col" style="width: 10%">ランプ</th>';
            table.insertAdjacentHTML('beforeend', th);
            for (let i = 0; i < Math.min(idx.length, display_number); i++) {
                let new_HTML = "<tr>";
                new_HTML += "<td>" + records[idx[i]]["title"] + "</td>";
                new_HTML += "<td>" + records[idx[i]]["score"] + "</td>";
                let level = String(records[idx[i]]["level"]);
                if (level.length > 2)
                    level = level.slice(0, 2) + "+";
                new_HTML += "<td>" + records[idx[i]]["diff"] + " " + level + "</td>";
                let lamp = "-";
                if (records[idx[i]]["is_alljustice"]) lamp = "AJ"
                else if (records[idx[i]]["is_fullcombo"]) lamp = "FC"
                new_HTML += "<td>" + lamp + "</td>";
                new_HTML += "</tr>";
                table.insertAdjacentHTML('beforeend', new_HTML);
            }
        }

        async function OnButtonClick() {
            if (!(await callApi())) return;
            let records = pickUpRecords(records_origin);
            setTable(records);
        }
    </script>
</head>

<body class="m-md-5">
    <div class="container-fluid m-md-3">
        <div class="d-flex flex-row">
            <div class="form-group">
                <label>chunirec のユーザー ID: <input class="form-control" id="user_id" type="text" minlength="1"
                        maxlength="20" size="20" /></label>
            </div>
            <p id="user_id_error" style="color:red"></p>
        </div>
    </div>

    <div class="container-fluid m-md-3">
        <div class="d-flex flex-row">
            <div class="form-group">
                <label"> 以上
                    <select id="level_lower" class="form-control">
                        <option value="10" selected>10</option>
                        <option value="10.5">10+</option>
                        <option value="11">11</option>
                        <option value="11.5">11+</option>
                        <option value="12">12</option>
                        <option value="12.5">12+</option>
                        <option value="13">13</option>
                        <option value="13.5">13+</option>
                        <option value="14">14</option>
                        <option value="14.5">14+</option>
                        <option value="15">15</option>
                    </select>
                    </label>
            </div>
            <div class="form-group">
                <label style="margin-left:20px;"> 以下
                    <select id="level_upper" class="form-control">
                        <option value="10">10</option>
                        <option value="10.5">10+</option>
                        <option value="11">11</option>
                        <option value="11.5">11+</option>
                        <option value="12">12</option>
                        <option value="12.5">12+</option>
                        <option value="13">13</option>
                        <option value="13.5">13+</option>
                        <option value="14">14</option>
                        <option value="14.5">14+</option>
                        <option value="15" selected>15</option>
                    </select>
                </label>
            </div>
            <div class="form-check" style="margin-left:10px; align-items:flex-end;">
                <input type="checkbox" id="ultima" checked class="form-check-input">
                <label class="form-check-label" for="ultima">ULTIMA を含む </label>
            </div>
        </div>
    </div>

    <div class="container-fluid m-md-3">
        <div class="d-flex flex-row mb-3">
            <div class="form-check">
                <input class="form-check-input" type="radio" name="achievement" id="radio_AJC" checked>
                <label class="form-check-label" for="radio_AJC">未理論値</label>
            </div>
            <div class="form-check" style="margin-left:10px;">
                <input class="form-check-input" type="radio" name="achievement" id="radio_99AJ">
                <label class="form-check-label" for="radio_99AJ">未99AJ</label>
            </div>
            <div class="form-check" style="margin-left:10px;">
                <input class="form-check-input" type="radio" name="achievement" id="radio_AJ">
                <label class="form-check-label" for="radio_AJ">未AJ</label>
            </div>
        </div>

    </div>
    <div class="container-fluid m-md-3">
        <div class="form-group">
            <label> 表示曲数:
                <select id="display_number" class="form-control">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="5" selected>5</option>
                    <option value="10">10</option>
                    <option value="20">20</option>
                    <option value="50">50</option>
                </select>
            </label>
        </div>
    </div>
    <div class="container-fluid m-md-3">
        <label> <input type="button" class="btn btn-primary" value="表示" onclick="OnButtonClick();" /></label>
    </div>
    <div class="container-fluid m-md-3">
        <p id="music_count"></p>
    </div>
    <div class="container-fluid m-md-3">
        <table id="table" class="table table-bordered"></table>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
</body>

</html>